<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VEX Timer + Bezier Path Planner</title>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button, select, input { padding: 6px; margin: 4px; }
table { border-collapse: collapse; width: 100%; margin-top: 15px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
.good { background: #c8f7c5; }
.bad { background: #f7c5c5; }

#fieldContainer { position: relative; width: 1050px; height: 1050px; margin-top: 20px; border:1px solid #aaa;}
#fieldImage { width:100%; height:100%; display:block; pointer-events:none;}
#fieldCanvas { position:absolute; top:0; left:0; cursor:crosshair; }

#autonOutput { width: 100%; height: 150px; margin-top: 10px; font-family: monospace; }
</style>
</head>

<body>

<h2>VEX Push Back Practice + Path Planner</h2>

<h3>Section Setup</h3>
<table>
<thead>
<tr><th>Name</th><th>Distance (inches)</th><th>Delete</th></tr>
</thead>
<tbody id="sectionTable"></tbody>
</table>
<button onclick="addSection()">Add Section</button>

<hr>

<label>Mode:</label>
<select id="mode" onchange="renderResults()">
  <option value="driver">Driver</option>
  <option value="auton">Auton</option>
</select>

<br><br>
<label>Section:</label>
<select id="sectionSelect" onchange="loadPath()"></select>

<button onclick="startSection()">Start</button>
<button onclick="stopSection()">Stop</button>
<p id="timer">Time: 0.00 s</p>

<h3>Results</h3>
<table>
<thead>
<tr>
  <th>Section</th>
  <th>Best</th>
  <th>Current</th>
  <th>Î” vs Best</th>
  <th>Speed (mph)</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="resultsTable"></tbody>
</table>

<h3>Field Map</h3>
<div id="fieldContainer">
  <img id="fieldImage" src="field.png">
  <canvas id="fieldCanvas" width="1050" height="1050"></canvas>
</div>
<button onclick="clearPath()">Clear Path</button>
<button onclick="exportAuton()">Export Auton</button>

<textarea id="autonOutput" placeholder="Auton coordinates will appear here..." readonly></textarea>

<script>
/* ---------- DATA ---------- */
let sections = JSON.parse(localStorage.getItem("sections")) || [{ name:"Start to Goal", distance:12 }];
let runs = JSON.parse(localStorage.getItem("runs")) || { driver:{}, auton:{} };
let paths = JSON.parse(localStorage.getItem("paths")) || {}; // store paths per section

let startTime=null, timerInterval=null, activeSection=null;

/* ---------- INIT ---------- */
renderSectionSetup();
renderSectionDropdown();
renderResults();
loadPath();

/* ---------- SECTION SETUP ---------- */
function renderSectionSetup(){
  const t=document.getElementById("sectionTable"); t.innerHTML="";
  sections.forEach((s,i)=>{
    const r=t.insertRow();
    const n=document.createElement("input"); n.value=s.name;
    n.onchange=()=>{sections[i].name=n.value; save();};
    const d=document.createElement("input"); d.type="number"; d.step="0.01"; d.value=s.distance;
    d.onchange=()=>{sections[i].distance=parseFloat(d.value); save();};
    const del=document.createElement("button"); del.textContent="ðŸ—‘";
    del.onclick=()=>{sections.splice(i,1); delete paths[i]; save();};
    r.insertCell().appendChild(n);
    r.insertCell().appendChild(d);
    r.insertCell().appendChild(del);
  });
}

function addSection(){
  sections.push({name:"New Section", distance:12});
  save();
}

function save(){
  localStorage.setItem("sections", JSON.stringify(sections));
  localStorage.setItem("runs", JSON.stringify(runs));
  localStorage.setItem("paths", JSON.stringify(paths));
  renderSectionSetup();
  renderSectionDropdown();
  renderResults();
}

function renderSectionDropdown(){
  const s=document.getElementById("sectionSelect");
  s.innerHTML="";
  sections.forEach((sec,i)=>{
    const o=document.createElement("option"); o.value=i; o.textContent=sec.name;
    s.appendChild(o);
  });
}

/* ---------- TIMER ---------- */
function startSection(){
  if(timerInterval) return;
  activeSection=document.getElementById("sectionSelect").value;
  startTime=performance.now();
  timerInterval=setInterval(()=>{
    document.getElementById("timer").textContent="Time: "+((performance.now()-startTime)/1000).toFixed(2)+" s";
  },30);
}

function stopSection(){
  if(!timerInterval) return;
  clearInterval(timerInterval); timerInterval=null;
  const t=(performance.now()-startTime)/1000;
  const m=document.getElementById("mode").value;
  runs[m][activeSection]??=[];
  runs[m][activeSection].push(t);
  save();
}

/* ---------- RESULTS ---------- */
function renderResults(){
  const tb=document.getElementById("resultsTable"); tb.innerHTML="";
  const m=document.getElementById("mode").value;
  sections.forEach((s,i)=>{
    const data=runs[m][i]||[];
    const best=data.length?Math.min(...data):null;
    const cur=data.length?data[data.length-1]:null;
    const r=tb.insertRow();
    r.insertCell().textContent=s.name;
    r.insertCell().textContent=best!==null?best.toFixed(2):"â€”";
    r.insertCell().textContent=cur!==null?cur.toFixed(2):"â€”";
    const d=r.insertCell();
    d.textContent=(cur!==null && best!==null)?(cur-best).toFixed(2):"â€”";
    d.className=(cur!==null && best!==null && cur<=best)?"good":"bad";
    r.insertCell().textContent=cur!==null?(s.distance/cur*2.23694).toFixed(2):"â€”"; // mph
    const del=document.createElement("button"); del.textContent="ðŸ—‘";
    del.onclick=()=>{if(data.length) data.pop(); renderResults();}
    r.insertCell().appendChild(del);
  });
}

/* ---------- PATH DRAWING ---------- */
const canvas=document.getElementById("fieldCanvas");
const ctx=canvas.getContext("2d");
const POINT_RADIUS=6, HANDLE_RADIUS=4;
let currentPath=null;
let dragging=null;

canvas.addEventListener("mousedown",e=>{
  const p=getMouse(e);
  dragging=findHit(p);
  if(dragging) return;
  addPoint(p.x,p.y);
});

canvas.addEventListener("mousemove",e=>{
  if(!dragging) return;
  const p=getMouse(e);
  dragging.obj.x=p.x; dragging.obj.y=p.y;
  draw();
});

canvas.addEventListener("mouseup",()=>dragging=null);
canvas.addEventListener("mouseleave",()=>dragging=null);

/* ----- PATH PER SECTION ----- */
function addPoint(x,y){
  const offset=60;
  const sec=document.getElementById("sectionSelect").value;
  paths[sec]??=[];
  paths[sec].push({x,y,h1:{x:x-offset,y},h2:{x:x+offset,y}});
  draw();
}

function clearPath(){
  const sec=document.getElementById("sectionSelect").value;
  paths[sec]=[];
  draw();
}

function loadPath(){
  draw();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBezierPath();
  drawHandles();
  drawPoints();
}

function drawBezierPath(){
  const sec=document.getElementById("sectionSelect").value;
  const pts=paths[sec]||[];
  if(pts.length<2) return;
  ctx.lineWidth=3; ctx.strokeStyle="blue"; ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++){
    const p0=pts[i-1]; const p1=pts[i];
    ctx.bezierCurveTo(p0.h2.x,p0.h2.y,p1.h1.x,p1.h1.y,p1.x,p1.y);
  }
  ctx.stroke();
}

function drawPoints(){
  const sec=document.getElementById("sectionSelect").value;
  const pts=paths[sec]||[];
  ctx.fillStyle="red"; ctx.font="14px Arial";
  pts.forEach((p,i)=>{ drawCircle(p.x,p.y,POINT_RADIUS); ctx.fillText(i+1,p.x+8,p.y-8); });
}

function drawHandles(){
  const sec=document.getElementById("sectionSelect").value;
  const pts=paths[sec]||[];
  ctx.strokeStyle="#888"; ctx.lineWidth=1;
  pts.forEach(p=>{
    ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p.h1.x,p.h1.y);
    ctx.moveTo(p.x,p.y); ctx.lineTo(p.h2.x,p.h2.y); ctx.stroke();
    ctx.fillStyle="green"; drawCircle(p.h1.x,p.h1.y,HANDLE_RADIUS); drawCircle(p.h2.x,p.h2.y,HANDLE_RADIUS);
  });
}

function drawCircle(x,y,r){ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();}

function getMouse(e){const r=canvas.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top};}
function findHit(p){ const sec=document.getElementById("sectionSelect").value; const pts=paths[sec]||[]; 
for(const pt of pts){ if(dist(p,pt)<POINT_RADIUS+2) return {obj:pt}; if(dist(p,pt.h1)<HANDLE_RADIUS+2) return {obj:pt.h1}; if(dist(p,pt.h2)<HANDLE_RADIUS+2) return {obj:pt.h2};} return null;}
function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}

/* ---------- AUTON EXPORT ---------- */
function exportAuton(){
  const lines=[];
  sections.forEach((s,i)=>{
    const pts=paths[i]||[];
    if(pts.length<1) return;
    lines.push(`// Section ${i+1}: ${s.name}`);
    pts.forEach(p=>{
      const x=(p.x/PX_PER_INCH).toFixed(2);
      const y=(p.y/PX_PER_INCH).toFixed(2);
      lines.push(`moveTo(${x}, ${y});`);
    });
  });
  const text=lines.join("\n");
  document.getElementById("autonOutput").value=text;
  navigator.clipboard.writeText(text);
  alert("Auton coordinates copied to clipboard!");
}

/* ---------- INIT ---------- */
draw();
</script>
</body>
</html>
