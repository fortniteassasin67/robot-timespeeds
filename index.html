<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VEX Timer + Path Planner</title>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button, select, input { padding: 6px; margin: 4px; }
table { border-collapse: collapse; width: 100%; margin-top: 15px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
.good { background: #c8f7c5; }
.bad { background: #f7c5c5; }

#fieldContainer { position: relative; width: 1050px; height: 1050px; margin-top: 20px; border:1px solid #aaa;}
#fieldImage { width:100%; height:100%; display:block; pointer-events:none; }
#fieldCanvas { position:absolute; top:0; left:0; cursor:crosshair; }

#autonOutput { width: 100%; height: 150px; margin-top: 10px; font-family: monospace; }
</style>
</head>

<body>

<h2>VEX Push Back Practice + Path Planner</h2>

<h3>Section Setup</h3>
<table>
<thead>
<tr><th>Name</th><th>Distance (inches)</th><th>Delete</th></tr>
</thead>
<tbody id="sectionTable"></tbody>
</table>
<button onclick="addSection()">Add Section</button>

<hr>

<label>Mode:</label>
<select id="mode" onchange="renderResults()">
  <option value="driver">Driver</option>
  <option value="auton">Auton</option>
</select>

<br><br>
<label>Section:</label>
<select id="sectionSelect"></select>

<button onclick="startSection()">Start</button>
<button onclick="stopSection()">Stop</button>
<p id="timer">Time: 0.00 s</p>

<h3>Results</h3>
<table>
<thead>
<tr>
  <th>Section</th>
  <th>Best</th>
  <th>Current</th>
  <th>Î” vs Best</th>
  <th>Speed (mph)</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="resultsTable"></tbody>
</table>

<h3>Field Map</h3>
<div id="fieldContainer">
  <img id="fieldImage" src="field.png">
  <canvas id="fieldCanvas" width="1050" height="1050"></canvas>
</div>
<button onclick="clearPath()">Clear Path</button>
<button onclick="exportAuton()">Export Auton</button>

<textarea id="autonOutput" placeholder="Auton coordinates will appear here..." readonly></textarea>

<script>
/* ---------- DATA ---------- */
let sections = JSON.parse(localStorage.getItem("sections")) || [{ name:"Start to Goal", distance:12 }];
let runs = JSON.parse(localStorage.getItem("runs")) || { driver:{}, auton:{} };
let paths = JSON.parse(localStorage.getItem("paths")) || {}; // store paths per section

let startTime=null, timerInterval=null;

/* ---------- INIT ---------- */
renderSectionSetup();
renderSectionDropdown();
renderResults();
draw();

/* ---------- SECTION SETUP ---------- */
function renderSectionSetup(){
  const t=document.getElementById("sectionTable"); t.innerHTML="";
  sections.forEach((s,i)=>{
    const r=t.insertRow();
    const n=document.createElement("input"); n.value=s.name;
    n.onchange=()=>{sections[i].name=n.value; save();};
    const d=document.createElement("input"); d.type="number"; d.step="0.01"; d.value=s.distance;
    d.onchange=()=>{sections[i].distance=parseFloat(d.value); save();};
    const del=document.createElement("button"); del.textContent="ðŸ—‘";
    del.onclick=()=>{sections.splice(i,1); delete paths[i]; save();};
    r.insertCell().appendChild(n);
    r.insertCell().appendChild(d);
    r.insertCell().appendChild(del);
  });
}

function addSection(){
  sections.push({name:"New Section", distance:12});
  save();
}

function save(){
  localStorage.setItem("sections", JSON.stringify(sections));
  localStorage.setItem("runs", JSON.stringify(runs));
  localStorage.setItem("paths", JSON.stringify(paths));
  renderSectionSetup();
  renderSectionDropdown();
  renderResults();
  draw();
}

function renderSectionDropdown(){
  const s=document.getElementById("sectionSelect");
  s.innerHTML="";
  sections.forEach((sec,i)=>{
    const o=document.createElement("option"); o.value=i; o.textContent=sec.name;
    s.appendChild(o);
  });
}

/* ---------- TIMER ---------- */
function startSection(){
  if(timerInterval) return;
  const activeSection=document.getElementById("sectionSelect").value;
  startTime=performance.now();
  timerInterval=setInterval(()=>{
    document.getElementById("timer").textContent="Time: "+((performance.now()-startTime)/1000).toFixed(2)+" s";
  },30);
}

function stopSection(){
  if(!timerInterval) return;
  clearInterval(timerInterval); timerInterval=null;
  const t=(performance.now()-startTime)/1000;
  const m=document.getElementById("mode").value;
  const sec=document.getElementById("sectionSelect").value;
  runs[m][sec]??=[];
  runs[m][sec].push(t);
  save();
}

/* ---------- RESULTS ---------- */
function renderResults(){
  const tb=document.getElementById("resultsTable"); tb.innerHTML="";
  const m=document.getElementById("mode").value;
  sections.forEach((s,i)=>{
    const data=runs[m][i]||[];
    const best=data.length?Math.min(...data):null;
    const cur=data.length?data[data.length-1]:null;
    const r=tb.insertRow();
    r.insertCell().textContent=s.name;
    r.insertCell().textContent=best!==null?best.toFixed(2):"â€”";
    r.insertCell().textContent=cur!==null?cur.toFixed(2):"â€”";
    const d=r.insertCell();
    d.textContent=(cur!==null && best!==null)?(cur-best).toFixed(2):"â€”";
    d.className=(cur!==null && best!==null && cur<=best)?"good":"bad";
    r.insertCell().textContent=cur!==null?(s.distance/cur*2.23694).toFixed(2):"â€”"; // mph
    const del=document.createElement("button"); del.textContent="ðŸ—‘";
    del.onclick=()=>{if(data.length) data.pop(); renderResults();}
    r.insertCell().appendChild(del);
  });
}

/* ---------- PATH DRAWING ---------- */
const canvas=document.getElementById("fieldCanvas");
const ctx=canvas.getContext("2d");
let drawing=false;
let currentPath=[];

canvas.addEventListener("mousedown", e=>{
  const sec=document.getElementById("sectionSelect").value;
  paths[sec] ??= [];
  drawing = true;
  const p = getMouse(e);
  currentPath = [p];
  paths[sec].push(currentPath);
  draw();
});

canvas.addEventListener("mousemove", e=>{
  if(!drawing) return;
  const p = getMouse(e);
  currentPath.push(p);
  draw();
});

canvas.addEventListener("mouseup", e=>{ drawing=false; });
canvas.addEventListener("mouseleave", e=>{ drawing=false; });

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawPaths();
}

function drawPaths(){
  const sec=document.getElementById("sectionSelect").value;
  const secPaths = paths[sec]||[];
  ctx.lineWidth=3; ctx.strokeStyle="blue";
  secPaths.forEach((pArr, idx)=>{
    if(!pArr.length) return;
    ctx.beginPath();
    ctx.moveTo(pArr[0].x, pArr[0].y);
    for(let i=1;i<pArr.length;i++){
      ctx.lineTo(pArr[i].x,pArr[i].y);
    }
    ctx.stroke();
    ctx.fillStyle="red"; ctx.font="14px Arial";
    ctx.fillText(idx+1,pArr[0].x+5,pArr[0].y-5);
  });
}

function clearPath(){
  const sec=document.getElementById("sectionSelect").value;
  paths[sec] = [];
  draw();
}

function getMouse(e){
  const r=canvas.getBoundingClientRect();
  return { x:e.clientX-r.left, y:e.clientY-r.top };
}

/* ---------- AUTON EXPORT ---------- */
const FIELD_INCHES = 144;
const PX_PER_INCH = canvas.width/FIELD_INCHES;

function exportAuton(){
  const lines=[];
  sections.forEach((s,i)=>{
    const secPaths = paths[i]||[];
    if(secPaths.length<1) return;
    lines.push(`// Section ${i+1}: ${s.name}`);
    secPaths.forEach(pArr=>{
      pArr.forEach(p=>{
        const x=(p.x/PX_PER_INCH).toFixed(2);
        const y=(p.y/PX_PER_INCH).toFixed(2);
        lines.push(`moveTo(${x}, ${y});`);
      });
    });
  });
  const text=lines.join("\n");
  document.getElementById("autonOutput").value=text;
  navigator.clipboard.writeText(text);
  alert("Auton coordinates copied to clipboard!");
}

/* ---------- INIT ---------- */
draw();
</script>
</body>
</html>
