<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VEX Push Back Practice</title>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button, select, input { padding: 6px; margin: 4px; }

table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }

.good { background: #c8f7c5; }
.bad  { background: #f7c5c5; }

#fieldContainer {
  position: relative;
  width: 900px;
  height: 900px;
  margin-top: 20px;
}

#fieldImage {
  width: 100%;
  height: 100%;
  pointer-events: none;
}

#fieldCanvas {
  position: absolute;
  top: 0;
  left: 0;
  cursor: crosshair;
}
</style>
</head>

<body>

<h2>VEX Push Back Practice</h2>

<h3>Section Setup</h3>
<table>
<thead>
<tr>
  <th>Name</th>
  <th>Distance (miles)</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="sectionTable"></tbody>
</table>
<button onclick="addSection()">Add Section</button>

<hr>

<label>Mode:</label>
<select id="mode" onchange="renderResults()">
  <option value="driver">Driver</option>
  <option value="auton">Auton</option>
</select>

<br><br>

<label>Section:</label>
<select id="sectionSelect"></select>

<button onclick="startRun()">Start</button>
<button onclick="stopRun()">Stop</button>

<p id="timer">Time: 0.00 s</p>

<h3>Results</h3>
<table>
<thead>
<tr>
  <th>Section</th>
  <th>Best (s)</th>
  <th>Current (s)</th>
  <th>Î” vs Best</th>
  <th>Speed (MPH)</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="resultsTable"></tbody>
</table>

<h3>Field Path Planner</h3>
<div id="fieldContainer">
  <img id="fieldImage" src="field.png">
  <canvas id="fieldCanvas" width="900" height="900"></canvas>
</div>

<button onclick="clearPaths()">Clear Paths</button>

<script>
/* ========= DATA ========= */
let sections = JSON.parse(localStorage.getItem("sections")) || [
  { name:"Start to Goal", distance:0.001 }
];

let runs = JSON.parse(localStorage.getItem("runs")) || {
  driver:{}, auton:{}
};

let activeSection = 0;
let running = false;
let startTime = 0;
let timerInterval = null;

/* ========= PATH DATA (GLOBAL) ========= */
let paths = JSON.parse(localStorage.getItem("paths")) || [];
let currentPath = null;

/* ========= INIT ========= */
renderSectionSetup();
renderSectionDropdown();
renderResults();
drawPaths();

/* ===== SECTION SETUP ===== */
function renderSectionSetup(){
  sectionTable.innerHTML="";
  sections.forEach((s,i)=>{
    const r=sectionTable.insertRow();

    const n=document.createElement("input");
    n.value=s.name;
    n.onchange=()=>{ sections[i].name=n.value; save(); };

    const d=document.createElement("input");
    d.type="number";
    d.step="0.0001";
    d.value=s.distance;
    d.onchange=()=>{
      const v=parseFloat(d.value);
      sections[i].distance=Number.isFinite(v)?v:0;
      save();
    };

    const del=document.createElement("button");
    del.textContent="ðŸ—‘";
    del.onclick=()=>{
      sections.splice(i,1);
      delete runs.driver[i];
      delete runs.auton[i];
      activeSection=Math.max(0,activeSection-1);
      save(true);
    };

    r.insertCell().appendChild(n);
    r.insertCell().appendChild(d);
    r.insertCell().appendChild(del);
  });
}

function addSection(){
  sections.push({name:"New Section",distance:0});
  save(true);
}

function renderSectionDropdown(){
  sectionSelect.innerHTML="";
  sections.forEach((s,i)=>{
    const o=document.createElement("option");
    o.value=i;
    o.textContent=s.name;
    sectionSelect.appendChild(o);
  });
  sectionSelect.value=activeSection;
  sectionSelect.onchange=()=>{
    activeSection=parseInt(sectionSelect.value);
  };
}

/* ===== TIMER ===== */
function startRun(){
  if(running) return;
  running=true;
  startTime=performance.now();
  timerInterval=setInterval(()=>{
    timer.textContent=
      "Time: "+((performance.now()-startTime)/1000).toFixed(2)+" s";
  },30);
}

function stopRun(){
  if(!running) return;
  running=false;
  clearInterval(timerInterval);

  const t=(performance.now()-startTime)/1000;
  if(!Number.isFinite(t)||t<=0) return;

  const m=mode.value;
  if(!Array.isArray(runs[m][activeSection]))
    runs[m][activeSection]=[];

  runs[m][activeSection].push(t);
  save();
}

/* ===== RESULTS ===== */
function renderResults(){
  resultsTable.innerHTML="";
  const m=mode.value;

  sections.forEach((s,i)=>{
    const r=resultsTable.insertRow();
    r.insertCell().textContent=s.name;

    const data=runs[m][i]||[];
    if(!data.length){
      r.insertCell().textContent="â€”";
      r.insertCell().textContent="â€”";
      r.insertCell().textContent="â€”";
      r.insertCell().textContent="â€”";
    } else {
      const best=Math.min(...data);
      const cur=data[data.length-1];

      r.insertCell().textContent=best.toFixed(2);
      r.insertCell().textContent=cur.toFixed(2);

      const dCell=r.insertCell();
      dCell.textContent=(cur-best).toFixed(2);
      dCell.className=cur<=best?"good":"bad";

      const dist=s.distance||0;
      r.insertCell().textContent=
        dist>0?((dist*3600)/cur).toFixed(2)+" mph":"â€”";
    }

    const del=document.createElement("button");
    del.textContent="ðŸ—‘";
    del.onclick=()=>{
      if(data.length) data.pop();
      save();
    };
    r.insertCell().appendChild(del);
  });
}

/* ===== PATH DRAWING ===== */
const ctx=fieldCanvas.getContext("2d");

fieldCanvas.addEventListener("mousedown",e=>{
  const r=fieldCanvas.getBoundingClientRect();
  currentPath=[{x:e.clientX-r.left,y:e.clientY-r.top}];
  paths.push(currentPath);
});

fieldCanvas.addEventListener("mousemove",e=>{
  if(!currentPath) return;
  const r=fieldCanvas.getBoundingClientRect();
  currentPath.push({x:e.clientX-r.left,y:e.clientY-r.top});
  drawPaths();
});

fieldCanvas.addEventListener("mouseup",()=>{
  currentPath=null;
  save();
});

function drawPaths(){
  ctx.clearRect(0,0,900,900);
  ctx.lineWidth=3;
  ctx.font="18px Arial";
  ctx.fillStyle="red";

  paths.forEach((p,i)=>{
    ctx.beginPath();
    p.forEach((pt,j)=>j?ctx.lineTo(pt.x,pt.y):ctx.moveTo(pt.x,pt.y));
    ctx.strokeStyle="blue";
    ctx.stroke();
    if(p.length)
      ctx.fillText(i+1,p[0].x+5,p[0].y-5);
  });
}

function clearPaths(){
  paths=[];
  save();
}

/* ===== SAVE ===== */
function save(rebuild=false){
  localStorage.setItem("sections",JSON.stringify(sections));
  localStorage.setItem("runs",JSON.stringify(runs));
  localStorage.setItem("paths",JSON.stringify(paths));
  renderSectionSetup();
  if(rebuild) renderSectionDropdown();
  renderResults();
  drawPaths();
}
</script>

</body>
</html>
