<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VEX Push Back Practice</title>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button, select, input { padding: 6px; margin: 4px; }

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}
th { background: #eee; }
.good { background: #c8f7c5; }
.bad { background: #f7c5c5; }

#fieldContainer {
  position: relative;
  width: 900px;
  height: 900px;
  margin-top: 20px;
}
#fieldImage {
  width: 100%;
  height: 100%;
  pointer-events: none;
}
#fieldCanvas {
  position: absolute;
  top: 0;
  left: 0;
  cursor: crosshair;
}
</style>
</head>

<body>

<h2>VEX Push Back Practice</h2>

<h3>Section Setup</h3>
<table>
<thead>
<tr><th>Name</th><th>Distance (miles)</th><th>Delete</th></tr>
</thead>
<tbody id="sectionTable"></tbody>
</table>
<button onclick="addSection()">Add Section</button>

<hr>

<label>Mode:</label>
<select id="mode" onchange="renderResults(); drawPaths();">
  <option value="driver">Driver</option>
  <option value="auton">Auton</option>
</select>

<br><br>

<label>Section:</label>
<select id="sectionSelect" onchange="drawPaths()"></select>

<button onclick="startRun()">Start</button>
<button onclick="stopRun()">Stop</button>

<p id="timer">Time: 0.00 s</p>

<h3>Results</h3>
<table>
<thead>
<tr>
  <th>Section</th>
  <th>Best (s)</th>
  <th>Current (s)</th>
  <th>Î” vs Best</th>
  <th>Speed (MPH)</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="resultsTable"></tbody>
</table>

<h3>Field Map</h3>
<div id="fieldContainer">
  <img id="fieldImage" src="field.png">
  <canvas id="fieldCanvas" width="900" height="900"></canvas>
</div>

<button onclick="clearRuns()">Clear Runs</button>

<script>
/* ---------- DATA ---------- */
let sections = JSON.parse(localStorage.getItem("sections")) || [
  { name: "Start to Goal", distance: 0.001 }
];

let runs = JSON.parse(localStorage.getItem("runs")) || {
  driver: {},
  auton: {}
};

let startTime = null;
let timerInterval = null;
let currentPath = null;

/* ---------- INIT ---------- */
renderSectionSetup();
renderSectionDropdown();
renderResults();

/* ---------- SECTION SETUP ---------- */
function renderSectionSetup(){
  const t = document.getElementById("sectionTable");
  t.innerHTML = "";
  sections.forEach((s,i)=>{
    const r = t.insertRow();
    const n = document.createElement("input");
    n.value = s.name;
    n.onchange = ()=>{ sections[i].name=n.value; save(); };

    const d = document.createElement("input");
    d.type="number"; d.step="0.0001"; d.value=s.distance;
    d.onchange = ()=>{ sections[i].distance=parseFloat(d.value)||0; save(); };

    const del = document.createElement("button");
    del.textContent="ðŸ—‘";
    del.onclick = ()=>{ sections.splice(i,1); save(); };

    r.insertCell().appendChild(n);
    r.insertCell().appendChild(d);
    r.insertCell().appendChild(del);
  });
}

function addSection(){
  sections.push({ name:"New Section", distance:0.001 });
  save();
}

function renderSectionDropdown(){
  const s = document.getElementById("sectionSelect");
  s.innerHTML="";
  sections.forEach((sec,i)=>{
    const o=document.createElement("option");
    o.value=i; o.textContent=sec.name;
    s.appendChild(o);
  });
}

/* ---------- TIMER ---------- */
function startRun(){
  if(timerInterval) return;
  currentPath = [];
  startTime = performance.now();
  timerInterval = setInterval(()=>{
    document.getElementById("timer").textContent =
      "Time: " + ((performance.now()-startTime)/1000).toFixed(2) + " s";
  },30);
}

function stopRun(){
  if(!timerInterval) return;
  clearInterval(timerInterval);
  timerInterval=null;

  const time = (performance.now()-startTime)/1000;
  const m = mode.value;
  const sec = sectionSelect.value;

  if(!runs[m][sec]) runs[m][sec]=[];
  runs[m][sec].push({ time, path: currentPath });

  save();
}

/* ---------- RESULTS ---------- */
function renderResults(){
  const tb = document.getElementById("resultsTable");
  tb.innerHTML="";
  const m = mode.value;

  sections.forEach((s,i)=>{
    const data = runs[m][i] || [];
    const r = tb.insertRow();

    let best = null;
    let current = null;

    if(data.length){
      best = Math.min(...data.map(d=>d.time));
      current = data[data.length-1].time;
    }

    r.insertCell().textContent = s.name;
    r.insertCell().textContent = best!==null ? best.toFixed(2) : "â€”";
    r.insertCell().textContent = current!==null ? current.toFixed(2) : "â€”";

    const dCell = r.insertCell();
    if(best!==null && current!==null){
      dCell.textContent = (current-best).toFixed(2);
      dCell.className = current<=best ? "good":"bad";
    } else dCell.textContent="â€”";

    r.insertCell().textContent =
      (current!==null && s.distance>0)
      ? ((s.distance*3600)/current).toFixed(2)+" mph"
      : "â€”";

    const del=document.createElement("button");
    del.textContent="ðŸ—‘";
    del.onclick=()=>{
      if(data.length) data.pop();
      save();
    };
    r.insertCell().appendChild(del);
  });
}

/* ---------- PATH DRAWING ---------- */
const canvas = document.getElementById("fieldCanvas");
const ctx = canvas.getContext("2d");

canvas.addEventListener("mousedown",e=>{
  if(!timerInterval) return;
  const r=canvas.getBoundingClientRect();
  currentPath.push({x:e.clientX-r.left, y:e.clientY-r.top});
});

canvas.addEventListener("mousemove",e=>{
  if(!timerInterval || !currentPath) return;
  const r=canvas.getBoundingClientRect();
  currentPath.push({x:e.clientX-r.left, y:e.clientY-r.top});
  drawPaths();
});

canvas.addEventListener("mouseup",()=>{});

function drawPaths(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const m=mode.value;
  const sec=sectionSelect.value;
  const data=runs[m][sec]||[];

  ctx.lineWidth=3;
  ctx.font="20px Arial";

  data.forEach((run,i)=>{
    ctx.beginPath();
    run.path.forEach((p,j)=>j?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
    ctx.strokeStyle = (i===data.length-1)?"blue":"gray";
    ctx.stroke();
    if(run.path.length){
      ctx.fillStyle=ctx.strokeStyle;
      ctx.fillText(i+1, run.path[0].x+5, run.path[0].y-5);
    }
  });

  if(currentPath){
    ctx.beginPath();
    currentPath.forEach((p,j)=>j?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
    ctx.strokeStyle="blue";
    ctx.stroke();
  }
}

function clearRuns(){
  runs[mode.value][sectionSelect.value]=[];
  save();
}

function save(){
  localStorage.setItem("sections",JSON.stringify(sections));
  localStorage.setItem("runs",JSON.stringify(runs));
  renderSectionSetup();
  renderSectionDropdown();
  renderResults();
  drawPaths();
}
</script>

</body>
</html>
