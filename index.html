<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VEX Push Back Practice</title>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
button, select, input { padding: 6px; margin: 4px; }

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}
th { background: #eee; }

.good { background: #c8f7c5; }
.bad  { background: #f7c5c5; }

#fieldContainer {
  position: relative;
  width: 900px;
  height: 900px;
  margin-top: 20px;
}

#fieldImage {
  width: 100%;
  height: 100%;
  display: block;
}

#fieldCanvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 900px;
  height: 900px;
  z-index: 10;
  cursor: crosshair;
}
</style>
</head>

<body>

<h2>VEX Push Back Practice</h2>

<h3>Section Setup</h3>
<table>
<thead>
<tr>
  <th>Name</th>
  <th>Distance (miles)</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="sectionTable"></tbody>
</table>
<button onclick="addSection()">Add Section</button>

<hr>

<label>Mode:</label>
<select id="mode" onchange="renderResults(); drawPaths();">
  <option value="driver">Driver</option>
  <option value="auton">Auton</option>
</select>

<br><br>

<label>Section:</label>
<select id="sectionSelect" onchange="drawPaths()"></select>

<button onclick="startRun()">Start</button>
<button onclick="stopRun()">Stop</button>

<p id="timer">Time: 0.00 s</p>

<h3>Results</h3>
<table>
<thead>
<tr>
  <th>Section</th>
  <th>Best (s)</th>
  <th>Current (s)</th>
  <th>Î” vs Best</th>
  <th>Speed (MPH)</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="resultsTable"></tbody>
</table>

<h3>Field Map</h3>
<div id="fieldContainer">
  <img id="fieldImage" src="field.png">
  <canvas id="fieldCanvas" width="900" height="900"></canvas>
</div>

<button onclick="clearRuns()">Clear Runs</button>

<script>
/* ========== DATA ========== */
let sections = JSON.parse(localStorage.getItem("sections")) || [
  { name: "Start to Goal", distance: 0.001 }
];

let runs = JSON.parse(localStorage.getItem("runs")) || {
  driver: {},
  auton: {}
};

let running = false;
let startTime = 0;
let timerInterval = null;

let currentPath = [];
let isDrawing = false;

/* ========== INIT ========== */
renderSectionSetup();
renderSectionDropdown();
renderResults();
drawPaths();

/* ===== SECTION SETUP ===== */
function renderSectionSetup(){
  sectionTable.innerHTML = "";
  sections.forEach((s,i)=>{
    const r = sectionTable.insertRow();

    const n = document.createElement("input");
    n.value = s.name;
    n.onchange = () => { sections[i].name = n.value; save(); };

    const d = document.createElement("input");
    d.type = "number";
    d.step = "0.0001";
    d.value = s.distance;
    d.onchange = () => {
      const v = parseFloat(d.value);
      sections[i].distance = Number.isFinite(v) ? v : 0;
      save();
    };

    const del = document.createElement("button");
    del.textContent = "ðŸ—‘";
    del.onclick = () => { sections.splice(i,1); save(); };

    r.insertCell().appendChild(n);
    r.insertCell().appendChild(d);
    r.insertCell().appendChild(del);
  });
}

function addSection(){
  sections.push({ name:"New Section", distance:0 });
  save();
}

function renderSectionDropdown(){
  sectionSelect.innerHTML = "";
  sections.forEach((s,i)=>{
    const o = document.createElement("option");
    o.value = i;
    o.textContent = s.name;
    sectionSelect.appendChild(o);
  });
}

/* ===== TIMER ===== */
function startRun(){
  if (running) return;
  running = true;
  currentPath = [];
  startTime = performance.now();
  timerInterval = setInterval(()=>{
    timer.textContent =
      "Time: " + ((performance.now()-startTime)/1000).toFixed(2) + " s";
  }, 30);
}

function stopRun(){
  if (!running) return;
  running = false;
  clearInterval(timerInterval);

  const time = (performance.now() - startTime) / 1000;
  if (!Number.isFinite(time) || time <= 0) return;

  const m = mode.value;
  const s = sectionSelect.value;

  if (!Array.isArray(runs[m][s])) runs[m][s] = [];
  runs[m][s].push({ time, path: [...currentPath] });

  save();
}

/* ===== RESULTS ===== */
function renderResults(){
  resultsTable.innerHTML = "";
  const m = mode.value;

  sections.forEach((s,i)=>{
    const r = resultsTable.insertRow();
    r.insertCell().textContent = s.name;

    const data = runs[m][i] || [];

    if (data.length === 0){
      r.insertCell().textContent = "â€”";
      r.insertCell().textContent = "â€”";
      r.insertCell().textContent = "â€”";
      r.insertCell().textContent = "â€”";
    } else {
      const times = data.map(d=>d.time);
      const best = Math.min(...times);
      const cur  = times[times.length-1];

      r.insertCell().textContent = best.toFixed(2);
      r.insertCell().textContent = cur.toFixed(2);

      const delta = cur - best;
      const dCell = r.insertCell();
      dCell.textContent = delta.toFixed(2);
      dCell.className = delta <= 0 ? "good" : "bad";

      r.insertCell().textContent =
        s.distance > 0 ? ((s.distance*3600)/cur).toFixed(2)+" mph" : "â€”";
    }

    const del = document.createElement("button");
    del.textContent = "ðŸ—‘";
    del.onclick = () => {
      if (data.length) data.pop();
      save();
    };
    r.insertCell().appendChild(del);
  });
}

/* ===== PATH DRAWING ===== */
const canvas = document.getElementById("fieldCanvas");
const ctx = canvas.getContext("2d");

canvas.addEventListener("mousedown", e=>{
  if (!running) return;
  isDrawing = true;
  addPoint(e);
});

canvas.addEventListener("mousemove", e=>{
  if (!running || !isDrawing) return;
  addPoint(e);
  drawPaths();
});

canvas.addEventListener("mouseup", ()=> isDrawing=false);
canvas.addEventListener("mouseleave", ()=> isDrawing=false);

function addPoint(e){
  const r = canvas.getBoundingClientRect();
  currentPath.push({
    x: e.clientX - r.left,
    y: e.clientY - r.top
  });
}

function drawPaths(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const m = mode.value;
  const s = sectionSelect.value;
  const data = runs[m][s] || [];

  ctx.lineWidth = 3;
  ctx.font = "18px Arial";

  data.forEach((run,i)=>{
    ctx.beginPath();
    run.path.forEach((p,j)=>j?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
    ctx.strokeStyle = "gray";
    ctx.stroke();
    if (run.path.length){
      ctx.fillStyle = "gray";
      ctx.fillText(i+1, run.path[0].x+5, run.path[0].y-5);
    }
  });

  if (currentPath.length){
    ctx.beginPath();
    currentPath.forEach((p,j)=>j?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
    ctx.strokeStyle = "blue";
    ctx.stroke();
  }
}

function clearRuns(){
  runs[mode.value][sectionSelect.value] = [];
  save();
}

/* ===== SAVE ===== */
function save(){
  localStorage.setItem("sections", JSON.stringify(sections));
  localStorage.setItem("runs", JSON.stringify(runs));
  renderSectionSetup();
  renderSectionDropdown();
  renderResults();
  drawPaths();
}
</script>

</body>
</html>
