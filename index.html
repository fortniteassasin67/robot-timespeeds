<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VEX Push Back Dashboard</title>
<style>
body { font-family: Arial; padding: 20px; }
input, button, select { margin: 4px; padding: 4px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
.good { background: #c8f7c5; }
.bad { background: #f7c5c5; }
canvas { border:1px solid #000; margin-top:20px; display:block; }
#graph { margin-top:20px; }
</style>
</head>
<body>

<h2>VEX Push Back Dashboard</h2>

<label>Mode: </label>
<select id="mode" onchange="loadData()">
  <option value="driver">Driver</option>
  <option value="auton">Auton</option>
</select>

<hr>

<h3>Sections</h3>
<p>Name sections and set distance (meters/tiles).</p>
<div id="sections"></div>
<button onclick="addSection()">Add Section</button>

<hr>

<h3>Run Control</h3>
<button onclick="startRun()">Start</button>
<button onclick="stopRun()">Stop</button>
<p id="timer">Time: 0.00 s</p>

<hr>

<table id="table">
<tr><th>Run</th></tr>
</table>

<canvas id="fieldMap" width="600" height="600"></canvas>
<canvas id="graph" width="600" height="200"></canvas>

<script>
// -------------------------
// Section & Run Data
// -------------------------
let sections = JSON.parse(localStorage.getItem("sections")) || [
  {name:"S1", distance:1},
  {name:"S2", distance:1},
  {name:"S3", distance:1}
];

let runs = JSON.parse(localStorage.getItem("runs")) || {};
let startTime = null;
let interval = null;
let liveTimes = [];

// -------------------------
// Sections UI
// -------------------------
function saveSections() {
  localStorage.setItem("sections", JSON.stringify(sections));
  renderSections();
}

function addSection() {
  sections.push({name:"S"+(sections.length+1), distance:1});
  saveSections();
}

function renderSections() {
  const div = document.getElementById("sections");
  div.innerHTML = "";
  sections.forEach((s,i)=>{
    div.innerHTML += `
      Name: <input value="${s.name}" onchange="sections[${i}].name=this.value;saveSections()">
      Distance: <input type="number" step="0.01" value="${s.distance}" onchange="sections[${i}].distance=this.value;saveSections()">
      <br>`;
  });
}

// -------------------------
// Run Control
// -------------------------
function startRun() {
  startTime = performance.now();
  liveTimes = [];
  interval = setInterval(()=>{
    let elapsed = (performance.now()-startTime)/1000;
    document.getElementById("timer").innerText = "Time: " + elapsed.toFixed(2) + " s";

    // simulate live section times evenly for demo purposes
    let sectionTime = elapsed / sections.length;
    liveTimes = Array(sections.length).fill(sectionTime);
    drawSpeedGraph(liveTimes);
  },50);
}

function stopRun() {
  clearInterval(interval);
  const totalTime = (performance.now()-startTime)/1000;
  recordRun(totalTime);
}

// -------------------------
// Record Run
// -------------------------
function recordRun(totalTime) {
  const mode = document.getElementById("mode").value;
  runs[mode] = runs[mode] || [];

  let runData = sections.map(s => {
    let t = totalTime / sections.length;
    return {time: t, speed: s.distance / t};
  });

  runs[mode].push(runData);
  localStorage.setItem("runs", JSON.stringify(runs));
  renderTable();
  drawFieldMap();
  drawSpeedGraph(runData.map(r=>r.speed));
}

// -------------------------
// Load Data
// -------------------------
function loadData() {
  runs = JSON.parse(localStorage.getItem("runs")) || {};
  renderTable();
  drawFieldMap();
}

// -------------------------
// Table Rendering
// -------------------------
function renderTable() {
  const mode = document.getElementById("mode").value;
  const table = document.getElementById("table");
  table.innerHTML = "<tr><th>Run</th>";
  sections.forEach(s => table.innerHTML += `<th>${s.name}<br>(t / s)</th>`);
  table.innerHTML += "<th>Total</th></tr>";

  let best = sections.map(()=>Infinity);

  (runs[mode]||[]).forEach(run => run.forEach((s,i)=>best[i]=Math.min(best[i],s.time)));

  (runs[mode]||[]).forEach((run,i)=>{
    let row = table.insertRow();
    row.insertCell().innerText = i+1;
    let total = 0;
    run.forEach((s,j)=>{
      total += s.time;
      let delta = s.time - best[j];
      let cell = row.insertCell();
      cell.className = delta<=0?"good":"bad";
      cell.innerText = s.time.toFixed(2) + " / " + s.speed.toFixed(2);
    });
    row.insertCell().innerText = total.toFixed(2);
  });
}

// -------------------------
// Field Map Drawing
// -------------------------
function drawFieldMap() {
  const canvas = document.getElementById("fieldMap");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Field background
  ctx.fillStyle = "#f0f0f0";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Field boundary
  ctx.strokeStyle="#000";
  ctx.lineWidth=2;
  ctx.strokeRect(20,20,560,560);

  const mode = document.getElementById("mode").value;
  const runData = (runs[mode]||[]).slice(-1)[0]; // last run
  if(!runData) return;

  // Predefined curved points
  let points = [
    {x:50,y:550}, 
    {x:200,y:450},
    {x:400,y:400},
    {x:550,y:550}
  ];

  if(sections.length != points.length){
    points = [];
    for(let i=0;i<sections.length;i++){
      let ratio = i/(sections.length-1);
      points.push({x:50+ratio*500, y:550 - ratio*150});
    }
  }

  // Draw curved sections
  for(let i=0;i<points.length-1;i++){
    const s = runData[i];
    const color = s.time <= Math.min(...runData.map(r=>r.time)) ? "green" : "red";
    ctx.strokeStyle = color;
    ctx.lineWidth = 6;

    ctx.beginPath();
    ctx.moveTo(points[i].x, points[i].y);
    const cx = (points[i].x + points[i+1].x)/2;
    const cy = points[i].y;
    ctx.quadraticCurveTo(cx,cy,points[i+1].x,points[i+1].y);
    ctx.stroke();
  }

  // Section points
  points.forEach((p,i)=>{
    ctx.fillStyle="black";
    ctx.beginPath();
    ctx.arc(p.x,p.y,5,0,2*Math.PI);
    ctx.fill();
    ctx.fillText(sections[i].name,p.x+5,p.y-5);
  });
}

// -------------------------
// Live Speed Graph
// -------------------------
function drawSpeedGraph(speeds) {
  const canvas = document.getElementById("graph");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!speeds || speeds.length===0) return;

  const maxSpeed = Math.max(...speeds)*1.2;
  const widthPerSection = canvas.width / speeds.length;

  ctx.beginPath();
  ctx.moveTo(0,canvas.height - (speeds[0]/maxSpeed)*canvas.height);

  for(let i=0;i<speeds.length;i++){
    let x = i*widthPerSection + widthPerSection/2;
    let y = canvas.height - (speeds[i]/maxSpeed)*canvas.height;
    ctx.lineTo(x,y);
  }

  ctx.strokeStyle="blue";
  ctx.lineWidth=2;
  ctx.stroke();

  // Draw speed points
  for(let i=0;i<speeds.length;i++){
    let x = i*widthPerSection + widthPerSection/2;
    let y = canvas.height - (speeds[i]/maxSpeed)*canvas.height;
    ctx.fillStyle="red";
    ctx.beginPath();
    ctx.arc(x,y,4,0,2*Math.PI);
    ctx.fill();
    ctx.fillText(speeds[i].toFixed(2),x-10,y-10);
  }

  // Axis
  ctx.strokeStyle="black";
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(0,canvas.height);
  ctx.lineTo(canvas.width,canvas.height);
  ctx.stroke();
}

// -------------------------
// Initial Render
// -------------------------
renderSections();
loadData();
</script>

</body>
</html>
